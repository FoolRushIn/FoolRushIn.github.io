---
title: 应用层
sidebar: 'auto'
date: 2020-07-03
categories:
 - 计算机网络
tags:
 - 计算机网络
---
# 应用层

## 应用层协议原理

网络核心设备并不在应用层上起作用

### 网络应用程序体系结构

**应用程序体系结构**由应用程序研发者设计,规定了如何在各种端系统上组织该应用程序  
两种主流体系结构: 

- 客户--服务器体系结构
  - 客户相互之间不直接通信
  - 该服务器具有固定的,周知的地址
- 对等(P2P)体系结构
  - 对位于数据中心的专用服务器由最小的(或者没有)依赖. 相反, 应用程序在间断连接的主机对之间使用直接通信,这些主机对被称为**对等方**
  - 对等方并不为服务提供商所有, 为用户控制的桌面机和膝上机所有. 因为不必通过专门的服务器,该体系被称为**对等方到对等方**的
  - P2P体系结构最吸引人的特性之一是他们的**自扩展性**
    - 在一个P2P文件共享应用中,尽管每个对等方都由于请求文件产生工作量,但每个对等方通过向其他对等方分发文件也为系统增加服务能力
  - 面临的挑战
    - ISP友好: 大多数ISP受制于非对称的带宽应用, 下载>上载
    - 安全性: 由于高度分布和开放特性带来的安全问题
    - 激励:未来的P2P应用取决于说服用户资源提供带宽,存储和计算资源

### 进程通信

进行通信的是**进程**

- 当进程运行在**相同**端系统上时,通过进程间通信机制相互通信,进程间的通信的规则由端系统上的操作系统确定
- 在两个不同的端系统上的进程,通过跨越计算机网络交换**报文**而相互通信. 

1. 网络应用程序由成对的进程组成,将进程之一标识为客户端(发起通信的进程),另一进程标识为服务器(等待联系的进程)  

2. 进程通过一个称为**套接字(socket)**的软件接口向网络发送报文和从网络接收报文

   1. 进程相当于房子,而套接字相当于门
   2. 套接字是建立网络应用程序的可编程接口,因此套接字也称为应用程序和网络接口之间的**应用程序编程接口(API)**
   3. 应用程序开发者可以控制套接字在应用层底端的一切,但是对套接字的运输层端几乎没有控制权
      1. 对运输层的控制权:
         1. 选择运输层协议
         2. 也许能设定几个运输层参数,如最大缓存和最大报文段长度


#### 进程寻址

接收进程需要一个地址,需要定义两种信息:

1. 主机的地址
2. 定义在目的主机中的接收进程的标识符

在因特网中,主机由**IP地址**标识

### 可供应用程序使用的运输服务

一个运输层协议能够为调用它的应用程序提供的服务,大体分为四类:

1. 可靠数据传输
   1. 当一个运输协议提供这种服务时,发送进程只要将其数据传递进套接字,就可以完全相信该数据能无差错地到达接收进程
2. 吞吐量
   1. 具有吞吐量要求地应用程序被称为**带宽敏感地应用**
   2. 带宽敏感地应用具有特定的吞吐量要求,而**弹性应用**能够根据情况或多或少地利用可供使用的吞吐量
3. 定时
   1. 时间限制的要求
4. 安全性

### 因特网提供的运输服务

![](https://i.loli.net/2020/11/19/BwWS1k6KEudYa4o.png)

#### TCP服务

TCP服务模型包括两种服务:

- 面向连接的服务
  - 在应用层数据开始流动之前,TCP让客户和服务器互相交换运输层控制信息(即握手过程,提示客户端和服务器,使它们为大量的分组到来做好准备)
  - 在握手阶段后,一个TCP连接在两个进程的套接字之间建立了(双向连接)
  - 应用程序结束报文发送时,拆除该连接
- 可靠的数据传送服务
  - 无差错,按照适当顺序交付所有发送的数据,没有字节的丢失和冗余

TCP协议还具有**拥塞控制的机制**,能为互联网带来整体好处(不一定为通信进程带来直接好处): 当发送方和接收方之间的网络出现拥塞时,会抑制发送进程

**安全问题**

无论TCP还是UDP都没有提供任何加密机制  

TCP加强版: 安全套接字层(Secure Socket Layer, SSL). 

- 能做到传统TCP所作的一切,并提供了关键的进程到进程的安全性服务
- SSL不是于TCP和UDP在相同层次上的第三种因特网运输协议,而是一种对TCP的加强,这种强化是在应用层上实现的

#### UDP服务

- UDP是一种不提供不必要服务的轻量级运输协议,仅仅提供最小服务  
- UDP是无连接的,因此在两个进程通信之前没有握手过程  
- UDP提供不可靠数据传送服务,UDP协议不保证该报文将到达接收进程, 并也可能是乱序到达的



### 应用层协议

应用层协议定义了运行在不同端系统上的应用程序进程如何传递报文:

- 交换的报文类型, 例如请求报文和相应报文
- 各种报文类型的语法, 如报文中各个字段以及如何描述这些字段
- 字段的语义, 即字段中包含的信息
- 一个进程何时以及如何发送报文, 对报文进行响应的规则

==**应用层协议只是网络应用的一部分**==

## Web和HTTP

### HTTP概况

Web层的应用协议是超文本传输协议(HTTP), HTTP由两个程序实现: 一个客户程序和一个服务器程序,它们运行在不同的端系统中,通过交换HTTP报文进行会话. **HTTP定义了报文的结构以及客户和服务器进行报文交换的方式**

- Web页面是由**对象**组成的,一个对象只是一个文件,诸如一个HTML文件,一个JPEG图形,一个Java小程序或一个视屏片段
- Web浏览器实现了HTTP的客户端,Web服务器实现了HTTP的服务器端
- HTTP使用TCP作为它的支撑运输协议
- 因为HTTP服务器并不保存关于客户的任何信息,所以HTTP是一个**无状态协议**



### 非持续连接和持续链接

客户和服务器在一个相当长的时间范围内通信,客户发出一系列请求,有两种处理方式:

- 每个请求/相应对是经一个单独的TCP连接发送(**非持续连接**)

1. 非持续性连接的使用：每个TCP连接在服务器发送一个对象后关闭,即该连接不为其他的对象而持续下来.   

2. 往返时间(RTT)
   1. 往返时间是指一个段分组从客户到服务器然后再返回客户所花费的时间
   2. RTT包括传播时延,排队时延,分组处理时延
   3. 三次握手中前两个部分所耗费的时间占用了一个RTT,然后客户结合第三个部分并发送一个HTTP请求,服务器返回一个HTML文件,该请求/响应占用了另一个RRT
   4. **总的时间: 两个RTT(一个用于创建TCP,一个用于请求和响应) + 服务器传输HTML文件的时间**

- 所有的请求及其响应经相同的TCP连接发送(**持续连接**)



### HTTP报文格式

![请求报文格式](https://i.loli.net/2020/11/19/c7aGi9xYKZ4r6N3.png)

![响应报文格式](https://i.loli.net/2020/11/19/yQ8O9fhMI3aociA.png)

### cookie

cookie用于标识一个用户  
用户首次访问一个站点的时候,提供一个用户标识,在后继会话中,浏览器向服务器传递一个cookie首部,从而向该服务器标识了用户. 因此cookie可以在无状态的HTTP之上建立一个用户会话层. 

### Web缓存

Web缓存器也叫做代理服务器,是能够代表初始Web服务器来满足HTTP请求的网络实体  
Web缓存器有自己的磁盘存储空间,并在存储空间中保存最近请求过的对象的副本

举例: 浏览器正在请求对象

1. 浏览器建立一个到Web缓存器的TCP连接,并向Web缓存器中的对象发送一个HTTP请求
2. Web缓存器进行检查,看看本地是否存储了该对象的副本,如果有,Web缓存器就向客户浏览器用HTTP响应报文返回该对象
3. 如果Web缓存器中没有该对象,它就打开一个与该对象的初始服务器的TCP连接. Web缓存器则在这个缓存器到服务器的TCP连接上发送一个对该对象的HTTP请求. 在收到该请求后,初始服务器向该Web缓存器发送具有该对象的HTTP响应
4. 当Web缓存器接收到该对象的时候,他在本地存储空间存储一份副本,并向客户的浏览器用HTTP响应报文**发送该副本**(通过现有的客户浏览器和Web缓存器之间的TCP连接)

简而言之,先访问Web缓存器,如果有缓存的备份,就返回备份,没有就请求一个,存储备份,然后返回备份  
值得注意的是, Web缓存器既是服务器又是客户,取决于行为(发送或接收请求)

**条件GET方法**
避免缓存中的数据已经过时了(数据已经被更新,缓存中的没有更新),使用条件get方法:

1. 请求报文使用GET方法
2. 请求报文中包含一个 "If-Modified_Since:" 首部行, 值为一个时间:(例子中代理缓存器代表一个请求浏览器向Web服务器发送一个请求报文)
   1. 在该时间之后改对象被修改过
      1. 发送该对象
   2. 没有修改过
      1. 该Web服务器仍发送一个响应报文,但是响应报文中不包含对象

## 文件传输协议: FTP

FTP(File Transfer Protocol)是应用层的一个文件传输协议。其主要作用是在服务器和客户端之间实现文件的传输和共享。**FTP协议运行在TCP连接上**，保证了文件传输的可靠性（运行在UDP协议上的是TFTP协议）

FTP支持两种方式的传输：文本（ASCII）方式和二进制（Binary）方式。通常文本文件的传输采用ASCII方式，而图象、声音文件、加密和压缩文件等非文本文件采用二进制方式传输，如果为了从一个系统上传输文件而使用了与本地系统不同的计算机字节位数，那么就必须使用Tenex模式。FTP以ASCII方式作为默认的文件传输方式。

### 与HTTP协议的区别

Http和FTP都是文件传输协议，都是运行在tcp上面，但是他们也有一些重要的区别，FTP使用了两个并行的tcp来传输文件：**一个是控制连接（port:21），一个是数据连接(port:20)，**控制连接用于在两个主机之间传输控制信息，如口令，用户标识，存放、获取文件等命令。数据连接用于实际发送一个文件,发送完文件之后数据连接后会关闭。因为ftp协议使用一个独立的控制连接，所以，也称ftp的控制信息是带外（out-of-band）传送的。而Http协议是在传输文件的同一个tcp连接中发送请求和相应首部行的。因此，Http也可以说是带内（in-band）发送控制信息。

### FTP的两种传输模式

FTP有两种传输模式：主动（FTP Port）模式和被动（FTP Passive）模式。由于主动模式存在着安全问题，最近几年，大部分的TFP客户端开始默认使用被动模式。

#### 主动模式（Port）

主动模式的核心是TFP客户端告诉服务端自己开发那个端口作为数据端口，然后让服务端来连接自己。
 主动模式的连接建立一般是通过一些几个步骤：

1. 客户端随机打开一个本地大于1024的端口P1
2. 客户端通过端口P1向服务器控制端口（端口21）发起连接请求
3. 服务器进行认证成功，请求建立
4. 客户端对本地端口P2进行监听并向服务器发送“Port P1+1”告诉服务器，客户端的数据监听端口。
5. 服务器收到端口后，从自己的数据端口（端口20）发起连接，连接到客户端指定的数据端口P1+1.

#### 被动方式（Passive）

由于主动方式中，服务端需要主动连客户端，对于客户端的防火墙来说，属于外部连接内部，会出现被阻塞的情况。被动方式解决了这个问题。被动连接的核心是控制连接请求和数据连接请求都是由客户端发起。被动方式的步骤如下：

1. 客户端任意打开大约1024的两个本地端口（P1和P1+1）
2. P1端口发送请求连接服务器的21端口（控制连接端口）同时提交PASV命令。
3. 服务器收到请求后，会开启任意一个大约1024的端口P2，然后返回如下格式内容：
    227 entering passive mode(h1,h2,h3,h4,p1,p2)
4. 客户端收到服务端返回的内容后，计算出服务端开放的数据连接端口
5. 客户端通过P1+1端口向服务端的发送连接请求。进行数据传输。

**关于服务端返回的报文格式(h1,h2,h3,h4,p1,p2)具体含义如下：**

- h1,h2,h3,h4代表服务器的ip地址；
- p1,p2代表服务器监听的数据连接端口地址。计算方法为P1*256+P2

## DNS 因特网的目录服务

### DNS提供的服务

识别主机的两种方式: 通过主机名或IP地址  
人们喜欢便于记忆的主机名标识方式, 路由器喜欢定长的,有层次结构的IP地址  
为了实现主机名到IP地址转换的目录服务,用到域名系统(DNS)

DNS是:

1. **一个由分层的DNS服务器实现的分布式数据库**
2. **一个使得主机能够查询分布式数据库的应用层协议**

DNS服务器通常是运行BIND软件上的UNIX机器,DNS协议运行在UDP之上,使用53号端口

**DNS是应用层协议**, 其原因在于

1. 使用客户-服务器模式运行在通信的端系统之间

2. 在通信的端系统之间通过下面的端到端运输协议来传送DNS报文

   但是, DNS不是一个直接和用户打交道的应用,DNS是为因特网上的用户应用程序以及其他软件提供一种核心功能,即将主机名转换为其背后的IP地址. DNS采用了位于网络边缘的客户和服务器

DNS通常是由其他应用层协议使用的,包括HTTP SMTP FTP,将用户提供的主机名解析为IP地址

- 同一台主机上运行着DNS应用的客户端
- 浏览器从上述URL中抽取出主机名并传给DNS应用的客户端
- DNS客户端向DNS服务器发送一个包含主机名的请求
- DNS客户最终会收到一份回答报文, 包含对应于该主机名的IP地址
- 浏览器收到来自DNS的IP地址,向位于该IP地址的80端口的HTTP服务器进程发起一个TCP连接

**DNS的其他服务**

- 主机别名
  - 有复杂主机名的主句能拥有一个或者多个别名(本名被称为规范主机名), 别名更容易记忆
- 邮件服务器别名
- 负载分配
  - 繁忙的站点被冗余分布在多台服务器上,每台服务器均运行在不同的端系统上,每个都有着不同的IP地址

### DNS工作机理

DNS不采用集中式设计(如全球只有一个NDS服务器),有以下问题

1. 单点故障: 一旦崩溃,因特网就无了
2. 通信容量: 要处理所有的DNS查询
3. 远距离的集中式数据库
4. 维护: 每个新添加的主机都使得数据库需要更新

#### 分布式 层次数据库

DNS拥有大量的DNS服务器,以层次方式组织,并分布在全球范围内.  
大致有三种类型的DNS服务器

1. 根DNS服务器

2. 顶级域DNS服务器

3. 权威DNS服务器

   另外包括**本地DNS服务器**,它不在层次结构中,但是很重要

![](https://i.loli.net/2020/11/19/mysvGTEAKCSjVWf.png)

#### DNS缓存

为了改善时延性能并减少在因特网上到处传输的DNS报文数量,DNS广泛使用了缓存技术  
在一个请求链中,当某DNS服务器收到一个DNS回答时,它能将该回答中的信息缓存在本地存储器中

### DNS记录和报文

共同实现了DNS分布式数据库的所有DNS服务器存储了**资源记录(Resource Record, RR)**,RR提供了主机名到IP地址的映射. 每个DNS回答报文包含一条或多条RR

资源记录是一个包含了下列字段的4元组:  
(Name, Value, Type, TTL).   
TTL是该记录的生存时间,据欸的那个了资源记录应从缓存中删除的时间(如果TTL为0, 则不能缓存)

- Type=A,则Name是主机名,Value是对应的IP地址 (类型为A的RR提供了标准的主机名到IP地址的映射)
- Type=NS,则Name是域,Value是一个知道如何获取该域中主机IP地址的权威DNS服务器的主机名
- Type=CNAME,Value是别名为Name的主机对应的规范主机名
- Type=MX,Value是个别名为Name的邮件服务器的规范主机名

DNS报文

![](https://i.loli.net/2020/11/19/x23O1jA6UqZCLvN.png)

- 事务 ID：DNS 报文的 ID 标识。对于请求报文和其对应的应答报文，该字段的值是相同的。通过它可以区分 DNS 应答报文是对哪个请求进行响应的。
- 标志：DNS 报文中的标志字段。
- 问题计数：DNS 查询请求的数目。
- 回答资源记录数：DNS 响应的数目。
- 权威名称服务器计数：权威名称服务器的数目。
- 附加资源记录数：额外的记录数目（权威名称服务器对应 IP 地址的数目）。



基础结构部分中的标志字段又分为若干个字段，如图所示。



![](https://i.loli.net/2020/11/19/KqXcO4H8EPx32Fg.gif)

标志字段中每个字段的含义如下：

- QR（Response）：查询请求/响应的标志信息。查询请求时，值为 0；响应时，值为 1。
- Opcode：操作码。其中，0 表示标准查询；1 表示反向查询；2 表示服务器状态请求。
- AA（Authoritative）：授权应答，该字段在响应报文中有效。值为 1 时，表示名称服务器是权威服务器；值为 0 时，表示不是权威服务器。
- TC（Truncated）：表示是否被截断。值为 1 时，表示响应已超过 512 字节并已被截断，只返回前 512 个字节。
- RD（Recursion  Desired）：期望递归。该字段能在一个查询中设置，并在响应中返回。该标志告诉名称服务器必须处理这个查询，这种方式被称为一个递归查询。如果该位为 0，且被请求的名称服务器没有一个授权回答，它将返回一个能解答该查询的其他名称服务器列表。这种方式被称为迭代查询。
- RA（Recursion Available）：可用递归。该字段只出现在响应报文中。当值为 1 时，表示服务器支持递归查询。
- Z：保留字段，在所有的请求和应答报文中，它的值必须为 0。
- rcode（Reply code）：返回码字段，表示响应的差错状态。当值为 0 时，表示没有错误；当值为 1 时，表示报文格式错误（Format error），服务器不能理解请求的报文；当值为 2 时，表示域名服务器失败（Server  failure），因为服务器的原因导致没办法处理这个请求；当值为 3 时，表示名字错误（Name  Error），只有对授权域名解析服务器有意义，指出解析的域名不存在；当值为 4 时，表示查询类型不支持（Not  Implemented），即域名服务器不支持查询类型；当值为 5  时，表示拒绝（Refused），一般是服务器由于设置的策略拒绝给出应答，如服务器不希望对某些请求者给出应答。

## P2P应用

两种适用于P2P设计的应用: 文件分发和分布式散列表

## 套接字

- 欢迎套接字
  - 所有要域服务器通信的客户的起始接触点
- 连接套接字
  - 随后为与每个客户通信而生成的套接字



